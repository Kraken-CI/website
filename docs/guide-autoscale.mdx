---
id: guide-autoscale
title: Autoscale Guide
---

import Screen from "./common.jsx"

## Problem Statement

Maintaining a fixed number of machines for Kraken CI can be costly. If
there is no high traffic of builds that some machines sits idle and
waste power. The solution to this problem is autoscaling ie. spawning
machines with Kraken Agents dynamically depending on the current needs
in the Kraken CI. If there is submitted a new flow with many building
or testing jobs then new machines are spawned. When the flow completes
machines are terminated and no costs are incurred.

## Intro to the Solution


Kraken CI allows for creating executing machines dynamically in the
cloud when they are needed. They can be either virtual machines or
containers. When new jobs are triggered and there are no agents
available for them, new machines with Kraken agents are
spawned. The configuration of the way of spawning new machines is
located in agent groups.

Currently, Kraken CI autoscaling is supporting:

- AWS EC2 virtual machines

Details about configuration can be found in [the Kraken docs](autoscale-in-cloud).

## Global Cloud Settings

First, global settings have to be set to allow access to a given cloud
provider. Kraken In Web UI, on Kraken -> Settings page, in Cloud tab,
there is a form for collecting credentials to cloud providers:

<Screen img="screen-settings-cloud.png" />

In the case of AWS, there are required `Access Key` and `Secret Access Key`.

## Preparing Cloud Environment

In case of AWS it is also required to assign proper permissions so
that Kraken can create or destroy EC2 instances. List of all requires
permissions looks as follows:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:CreateKeyPair",
                "ec2:CreateSecurityGroup",
                "ec2:CreateTags",
                "ec2:DeleteKeyPair",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceStatus"
                "ec2:DescribeInstanceTypeOfferings",
                "ec2:DescribeRegions",
                "ec2:DescribeSecurityGroups",
                "ec2:DescribeVpcs",
                "ec2:RunInstances",
                "ec2:TerminateInstances",
            ],
            "Resource": "*"
        }
    ]
}
```

## Configuration in Agents Groups

Having set credentials to cloud providers, it is possible now to
configure aspects of spawning new machines. This can be done on Kraken
-> Agents -> Groups page.  When a particular group is selected, then
its details will be presented on a separate tab. On this tab, there is
a section `Agents Deployment`. So the deployment can be manual
(default) or automated to particular cloud providers.  In the case of
Amazon Web Services, there are the following options that can be set:

<Screen img="screen-agents-groups-cloud-aws.png" />



## Job Definition

Now when a job is assigned to an agents group with configured Agents
Deployment then a new machine will be spawned for that job if there
are no available agents.

## Run
